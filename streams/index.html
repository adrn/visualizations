<html>
    <head>
        <title>adrn | streams</title>

        <!-- Style / css -->
        <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:100,200,300,400,700,900' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" type="text/css" media="screen" href="../css/colorbrewer.css" />
        <link rel="stylesheet" type="text/css" href="../css/style.css" />
        <link rel="stylesheet" type="text/css" href="streams.css" />

        <!-- Javascript dependencies -->
        <script type="text/javascript" src="html_help.js"></script>
        <script type="text/javascript" src="streams.js"></script>
        
        <script type="text/javascript" src="../js/jquery-1.6.1.min.js"></script>
        <script type="text/javascript" src="../js/d3.v2.min.js"></script>
        <script type="text/javascript" src="utils.js"></script>
        
        <!-- TODO: new google analytics stuff -->
        <script type="text/javascript">
        </script>

    </head>

    <body>
        <div id="header">
            <h1>Stream maker</h1>
            
            <input type="button" id="demo_button" class="text_button" value="(add random galaxy)" onClick="random_galaxy(simulation, context, color_cycle());" />
            
            <table cellpadding=5 cellspacing=10 width="100%" class="control_panel">
                <tr>
                    <td class="label right">
                        trails:
                    </td>
                    <td>
                        <input type="checkbox" id="trails" onchange="toggle_trails();" />
                    </td>
                </tr>
                <tr>
                    <td class="label right">
                        speed:
                    </td>
                    <td>
                        <input type="range" style="width: 100px;" id="speed" min="-2" max="3" value="0.5" step="0.1" onMousedown="stop();" onMouseUp="start();" />
                    </td>
                </tr>

                <tr>
                    <td class="component_name" colspan=2>Potential</td>
                </tr>
                <tr>
                    <td class="label right">
                        q<sub>z</sub>:
                    </td>
                    <td class="label">
                        <!--<input type="range" style="width: 100px;" id="qz" min="0.71" max="1.2" value="0.8" step="0.01" onChange="$('#qz_display').val($(this).val());"/>-->
                        <input type="text" id="qz" value="0.8" size=5 />
                    </td>
                </tr>
                <tr>
                    <td class="label right">
                        v<sub>c</sub>:
                    </td>
                    <td class="label">
                        <!--<input type="range" style="width: 100px;" id="vc" min="120" max="300" value="220" step="1." onChange="$('#vc_display').val($(this).val());"/>-->
                        <input type="text" id="vc" value="220" size=5 />&nbsp;&nbsp;km/s
                    </td>
                </tr>

                <tr>
                    <td colspan=2></td>
                </tr>

                <tr>
                    <td class="component_name" colspan=2>Next galaxy</td>
                </tr>
                <tr>
                    <td class="label right"># of stars:</td>
                    <td class="label"><input type="text" id="num_stars" value="100" size=5 /></td>
                </tr>
                <tr>
                    <td class="label right">velocity disp:</td>
                    <td class="label"><input type="text" id="v_disp" value="1" size=5 />&nbsp;&nbsp;km/s</td>
                </tr>
                <tr>
                    <td class="label right">length scale:</td>
                    <td class="label"><input type="text" id="r_scale" value="1" size=5 />&nbsp;&nbsp;kpc</td>
                </tr>
                <tr>
                    <td class="label right">SFR:</td>
                    <td class="label"><input type="text" id="sfr" value="0" size=5 />&nbsp;&nbsp;stars/Myr</td>
                </tr>
                <tr>
                    <td class="label right">color:</td>
                    <td>
                        <select id="galaxy_color">
                            <option value="#2166AC">blue</option>
                            <option value="#1A9850">green</option>
                            <option value="#B2182B">red</option>
                            <option value="#998EC3">purple</option>
                            <option value="#FFFFBF">yellow</option>
                        </select>
                    </td>
                </tr>

                <tr>
                    <td colspan=2></td>
                </tr>
                
            </table>
            <center>
                <input type="button" class="control_button" value="&#9658;" onClick="start();" />
                <input type="button" class="control_button" value="ll" onClick="stop();" />
                <input type="button" class="control_button" value="clear" onClick="restart();" style="font-weight: 300;" />
            </center>
            <input type="button" id="hide_show_button" class="text_button" value="hide" onClick="toggle_menu();" /><!-- control_panel -->

        </div>
        
        <!-- Main canvas for drawing -->
        <canvas id="bgcanvas"></canvas>
        
        <div id="welcome">
            Click and drag to add a galaxy!   
        </div>
        
        <!-- Note at bottom for credits -->
        <div id="footer">
            Adrian Price-Whelan // adrn at astro.columbia.edu // <a href="https://twitter.com/astrodrian">@astrodrian</a>
        </div>
    </body>

    <script type="text/javascript">
        // Get javascript references to the canvas and context
        var canvas = document.getElementById('bgcanvas');
        var context = canvas.getContext('2d');

        // Fill the browser with the canvas
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        var interval,
            color_idx = 0,
            dt = 1.,
            draw_trails = false,
            new_galaxy_velocity = [0.,0.],
            pixel_scale=4.;

        // Define the potential
        var x0 = canvas.width / 2. / pixel_scale,
            y0 = canvas.height / 2. / pixel_scale;
        var potential = new LogarithmicPotential(x0, y0,
                                                 qz=$("#qz").val(),
                                                 vc=$("#vc").val());
        
        // Define the global simulation object
        var simulation = new StreamSimulation(canvas, potential, pixel_scale);
        simulation.draw(context);

        // Variables for keeping track of mouse click / drag positions
        var mouse_is_down = false,
            mouse_x0 = 0.,
            mouse_y0 = 0.,
            mouse_x1 = 0.,
            mouse_y1 = 0.;
        
        $('canvas').mousedown(function(e){
            /* Store that the mouse is down, save position of click */
            mouse_is_down = true;
            mouse_x0 = e.pageX;
            mouse_y0 = e.pageY;

            // reset new galaxy velocity
            new_galaxy_velocity = [0.,0.]
            
            // Stop simulation until mouse is up
            stop();
        });

        $('canvas').mouseup(function(e){
            /* Mouse is released, we can use the path drawn to get a velocity
                and add a new galaxy.
            */
            mouse_is_down = false;

            galaxy = new GaussianGalaxy([mouse_x0/pixel_scale, mouse_y0/pixel_scale], 
                                        new_galaxy_velocity, 
                                        $("#r_scale").val(), 
                                        $("#v_disp").val()*kms_to_kpcmyr,
                                        $("#num_stars").val(),
                                        $("#galaxy_color").val());
            galaxy.sfr = parseFloat($("#sfr").val());
            simulation.galaxies.push(galaxy);
            
            wipe_context(context);
            simulation.draw(context);
            
            $('#galaxy_color option:selected').removeAttr('selected')
                                              .next('option')
                                              .attr('selected', 'selected');
            
            start();
        });

        $('canvas').mousemove(function(e){
            if (mouse_is_down) {
                wipe_context(context);
                simulation.draw(context);
                
                // store present position of mouse
                mouse_x1 = e.pageX;
                mouse_y1 = e.pageY;
                var dx = mouse_x0-mouse_x1,
                    dy = mouse_y0-mouse_y1;
                
                // Scale from pixel units to km/s or whatever..
                new_galaxy_velocity = [-dx*2.*kms_to_kpcmyr, -dy*2.*kms_to_kpcmyr];

                context.lineWidth = 2;
                context.beginPath();
                context.moveTo(mouse_x0, mouse_y0);
                context.lineTo(mouse_x1, mouse_y1);
                context.strokeStyle = "#111111";
                context.stroke();
            }
        });
        
    </script>
</html>
